<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Monitoring</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #000;
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.68);
        --border: rgba(255, 255, 255, 0.14);
        --border-strong: rgba(255, 255, 255, 0.22);
        --accent: #d7ff45;
        --shadow: 0 16px 60px rgba(0, 0, 0, 0.55);
        --radius: 16px;
        --radius-lg: 22px;
        --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
        --container: 1320px;
        --green: #00d896;
        --yellow: #ffd166;
        --red: #ff7a7a;
        --font-heading: "Anton", sans-serif;
        --font-body: "Proxima Nova", sans-serif;
      }
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: var(--font-body); background: linear-gradient(90deg, #181818 0%, var(--bg) 60%); color: var(--text); min-height: 100vh; }
      h1,h2,h3,.title,.panel-title { font-family: var(--font-heading); font-weight: 400; }

      .page { padding: 20px 24px 64px; }
      .container { width: 100%; max-width: var(--container); margin: 0 auto; display: grid; gap: 16px; }

      .header { display: flex; align-items: flex-end; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
      .title { font-size: 48px; letter-spacing: 0.04em; text-transform: uppercase; line-height: 1; }
      .subtitle { color: var(--muted); font-size: 13px; line-height: 1.6; }

      .button { border-radius: 999px; padding: 9px 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; border: 1px solid var(--border); background: rgba(255,255,255,0.02); color: var(--text); cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; line-height: 1; transition: transform 180ms var(--ease), border-color 180ms var(--ease), background 180ms var(--ease); }
      .button:hover { transform: translateY(-1px); border-color: var(--border-strong); background: rgba(255,255,255,0.04); }
      .button.primary { background: var(--accent); color: #000; border-color: transparent; }
      .button.sm { padding: 5px 10px; font-size: 10px; }
      .button.danger { border-color: rgba(255,120,120,0.5); color: var(--red); }
      .button.active-filter { background: rgba(255,255,255,0.1); border-color: var(--accent); }

      .stats-bar { display: flex; gap: 12px; flex-wrap: wrap; }
      .stat { border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; background: rgba(0,0,0,0.3); min-width: 120px; }
      .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.14em; color: var(--muted); margin-bottom: 4px; }
      .stat-value { font-size: 24px; font-family: var(--font-heading); letter-spacing: 0.04em; }

      .toolbar { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
      .search-input { border-radius: 10px; border: 1px solid var(--border); background: rgba(0,0,0,0.3); color: var(--text); padding: 8px 12px; font-size: 12px; width: 220px; }
      .search-input::placeholder { color: var(--muted); }

      .monitor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; }

      .student-card { border: 1px solid var(--border); border-radius: var(--radius-lg); background: rgba(255,255,255,0.02); overflow: hidden; transition: border-color 200ms var(--ease), box-shadow 200ms var(--ease); position: relative; }
      .student-card:hover { border-color: var(--border-strong); }
      .student-card.flagged { border-color: rgba(255,120,120,0.4); box-shadow: 0 0 20px rgba(255,80,80,0.1); }
      .student-card.watched { border-color: rgba(215,255,69,0.5); box-shadow: 0 0 20px rgba(215,255,69,0.08); }
      .student-card.reviewed { border-color: rgba(255, 214, 64, 0.6); box-shadow: 0 0 20px rgba(255, 214, 64, 0.12); }

      .card-frame { width: 100%; height: 170px; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
      .card-frame video { width: 100%; height: 100%; object-fit: cover; display: block; background: #000; }
      .card-frame .no-feed { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.12em; }

      .card-badge { position: absolute; top: 8px; left: 8px; border-radius: 999px; padding: 3px 8px; font-size: 9px; text-transform: uppercase; letter-spacing: 0.12em; font-weight: 600; z-index: 2; }
      .badge-active { background: rgba(0,216,150,0.25); color: var(--green); border: 1px solid rgba(0,216,150,0.4); }
      .badge-completed { background: rgba(255,255,255,0.08); color: var(--muted); border: 1px solid var(--border); }
      .badge-flagged { background: rgba(255,120,120,0.25); color: var(--red); border: 1px solid rgba(255,120,120,0.4); }

      .card-integrity { position: absolute; top: 8px; right: 8px; border-radius: 999px; padding: 3px 8px; font-size: 10px; font-weight: 700; letter-spacing: 0.08em; border: 1px solid var(--border); background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 2; }

      .card-body { padding: 12px 14px; display: grid; gap: 8px; }
      .card-name { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .card-email { font-size: 11px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

      .card-stats { display: flex; gap: 10px; font-size: 11px; color: var(--muted); }
      .card-stats span { display: flex; align-items: center; gap: 4px; }
      .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }

      .card-violations-mini { display: flex; gap: 4px; flex-wrap: wrap; }
      .violation-chip { border-radius: 6px; padding: 2px 6px; font-size: 9px; text-transform: uppercase; letter-spacing: 0.08em; background: rgba(255,120,120,0.15); color: var(--red); border: 1px solid rgba(255,120,120,0.25); }

      .card-actions { display: flex; gap: 6px; padding: 0 14px 12px; flex-wrap: wrap; }

      .watch-btn { position: absolute; bottom: 56px; right: 10px; width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border); background: rgba(0,0,0,0.5); color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; z-index: 2; backdrop-filter: blur(4px); transition: all 160ms var(--ease); }
      .watch-btn:hover, .watch-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(215,255,69,0.1); }

      .logs-panel { border: 1px solid var(--border); border-radius: var(--radius-lg); background: rgba(255,255,255,0.02); overflow: hidden; }
      .logs-header { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
      .panel-title { text-transform: uppercase; letter-spacing: 0.12em; font-size: 12px; }
      .logs-scroll { max-height: 360px; overflow-y: auto; }
      .log-row { display: grid; grid-template-columns: 90px 80px 140px 140px 1fr; gap: 8px; padding: 10px 18px; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 11px; align-items: center; }
      .log-row:hover { background: rgba(255,255,255,0.02); }
      .log-time { color: var(--muted); font-variant-numeric: tabular-nums; }
      .log-session { color: var(--muted); font-family: monospace; font-size: 10px; }
      .log-student { color: rgba(255,255,255,0.82); font-size: 11px; }
      .log-event { text-transform: uppercase; letter-spacing: 0.06em; font-weight: 600; font-size: 10px; }
      .log-event.violation { color: var(--red); }
      .log-event.info { color: var(--green); }
      .log-explain { color: var(--muted); }
      .log-empty { padding: 24px 18px; color: var(--muted); font-size: 12px; }

      .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; padding: 24px; z-index: 50; }
      .modal-backdrop.show { display: flex; }
      .modal { max-width: 520px; width: 100%; border-radius: var(--radius-lg); border: 1px solid var(--border); background: rgba(15, 15, 18, 0.98); padding: 20px; display: grid; gap: 14px; box-shadow: var(--shadow); }
      .modal h3 { text-transform: uppercase; letter-spacing: 0.12em; font-size: 16px; }
      .modal p { color: var(--muted); font-size: 13px; line-height: 1.6; }
      .modal-actions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
      .modal select { border-radius: 10px; border: 1px solid var(--border); background: rgba(0,0,0,0.35); color: var(--text); padding: 8px 10px; font-size: 12px; }
      .modal .helper { font-size: 11px; color: var(--muted); }

      @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
      .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; animation: pulse 1.5s infinite; margin-right: 6px; }


      @media (max-width: 768px) {
        .monitor-grid { grid-template-columns: 1fr; }
        .log-row { grid-template-columns: 70px 120px 1fr; }
        .log-session { display: none; }
        .log-explain { display: none; }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="container">
        <header class="header">
          <div>
            <div class="title">Live Monitor</div>
            <div class="subtitle" id="monitor-subtitle">Loading...</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="button" id="btn-pause" type="button"><span class="live-dot"></span>Live</button>
            <a class="button" href="faculty.html">Back to Dashboard</a>
          </div>
        </header>

        <div class="stats-bar">
          <div class="stat"><div class="stat-label">Active</div><div class="stat-value" id="stat-active">-</div></div>
          <div class="stat"><div class="stat-label">Total</div><div class="stat-value" id="stat-total">-</div></div>
          <div class="stat"><div class="stat-label">Flagged</div><div class="stat-value" id="stat-flagged" style="color:var(--red)">-</div></div>
          <div class="stat"><div class="stat-label">Watching</div><div class="stat-value" id="stat-watching" style="color:var(--accent)">-</div></div>
        </div>

        <div class="toolbar">
          <input class="search-input" id="search" type="text" placeholder="Search student name or email..." />
          <button class="button sm" id="filter-all">All</button>
          <button class="button sm" id="filter-active">Active Only</button>
          <button class="button sm" id="filter-flagged">Flagged</button>
          <button class="button sm" id="filter-watched">Watched</button>
        </div>

        <div class="monitor-grid" id="grid"></div>

        <div class="logs-panel">
          <div class="logs-header">
            <div class="panel-title" id="log-title">Live Activity Log</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button class="button sm" id="log-reset" type="button">All Logs</button>
              <span style="font-size:11px;color:var(--muted);" id="log-count">0 events</span>
            </div>
          </div>
          <div class="logs-scroll" id="logs-scroll"></div>
        </div>
      </div>
    </div>

    <div id="action-modal" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <h3 id="action-title">Action</h3>
        <p id="action-desc"></p>
        <div id="action-body"></div>
        <div class="modal-actions">
          <button class="button" id="action-cancel" type="button">Cancel</button>
          <button class="button primary" id="action-confirm" type="button">Confirm</button>
        </div>
      </div>
    </div>

    <script src="api.js"></script>
    <script>
      (() => {
        if (!Morpheus.requireAuth("professor")) return;

        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.replace("#", ""));
        const exam_id = urlParams.get("exam_id") || hashParams.get("exam_id");
        console.log("[MONITOR] exam_id:", exam_id, "url:", window.location.href);

        const $ = (id) => document.getElementById(id);
        const grid = $("grid");
        const logsEl = $("logs-scroll");
        const actionModal = $("action-modal");
        const actionTitle = $("action-title");
        const actionDesc = $("action-desc");
        const actionBody = $("action-body");
        const actionCancel = $("action-cancel");
        const actionConfirm = $("action-confirm");

        if (!exam_id) {
          $("monitor-subtitle").textContent = "No exam selected.";
          grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;"><a class="button primary" href="faculty.html">Go to Dashboard</a></div>';
          return;
        }

        const VLABEL = {
          phone_detected:"Phone", gaze_away:"Gaze Away", tab_switch:"Tab Switch",
          raf_tab_switch:"Tab Switch", speech_detected:"Speech", speech_cheating:"Cheating Speech",
          multiple_faces:"Multi-Face", no_mouse:"No Mouse", screenshot_attempt:"Screenshot",
          copy_paste:"Copy/Paste", window_resize:"Resize", multiple_monitors:"Multi-Monitor",
          screen_share_detected:"Screen Share",
        };
        const VEXPLAIN = {
          phone_detected:"Mobile device in camera", gaze_away:"Looking away from screen",
          tab_switch:"Browser tab switch", raf_tab_switch:"Tab switch via frame timing",
          speech_detected:"Voice activity detected", speech_cheating:"Suspicious speech content",
          multiple_faces:"Multiple people in frame", no_mouse:"Mouse left exam window",
          screenshot_attempt:"Screenshot attempt", copy_paste:"Copy/paste blocked",
          window_resize:"Window resized", multiple_monitors:"Multiple monitors",
          screen_share_detected:"Screen sharing", session_started:"Exam session started",
          session_finished:"Exam submitted",
        };

        const watchlist = new Set(JSON.parse(sessionStorage.getItem("monitor_watchlist") || "[]"));
        const reviewlist = new Set(JSON.parse(sessionStorage.getItem("monitor_reviewlist") || "[]"));
        let filter = "all", search = "", paused = false;
        let students = [], logs = [], examTitle = null;
        let selectedSessionId = null;
        let pendingAction = null;

        // ---- Helpers ----
        const esc = (s) => { const d = document.createElement("div"); d.textContent = s||""; return d.innerHTML; };
        const iColor = (v) => v > 80 ? "var(--green)" : v >= 50 ? "var(--yellow)" : "var(--red)";
        const saveWatch = () => sessionStorage.setItem("monitor_watchlist", JSON.stringify([...watchlist]));
        const saveReview = () => sessionStorage.setItem("monitor_reviewlist", JSON.stringify([...reviewlist]));

        const openModal = (title, description, bodyNode, onConfirm) => {
          actionTitle.textContent = title;
          actionDesc.textContent = description;
          actionBody.innerHTML = "";
          if (bodyNode) actionBody.appendChild(bodyNode);
          pendingAction = onConfirm;
          actionModal.classList.add("show");
        };

        const closeModal = () => {
          actionModal.classList.remove("show");
          pendingAction = null;
        };

        // ---- Stats ----
        const renderStats = () => {
          $("stat-active").textContent = students.filter(s => s.status==="active").length;
          $("stat-total").textContent = students.length;
          $("stat-flagged").textContent = students.filter(s => s.integrity_score<50).length;
          $("stat-watching").textContent = watchlist.size;
          const label = examTitle || exam_id.slice(0,8) + "...";
          $("monitor-subtitle").textContent = `${label} | ${paused ? "Paused" : "Live"}`;
        };

        // ---- Filtering/Sorting ----
        const getVisible = () => {
          let list = students;
          if (search) { const q = search.toLowerCase(); list = list.filter(s => s.student_name.toLowerCase().includes(q) || s.student_email.toLowerCase().includes(q)); }
          if (filter === "active") list = list.filter(s => s.status==="active");
          else if (filter === "flagged") list = list.filter(s => s.integrity_score<50);
          else if (filter === "watched") list = list.filter(s => watchlist.has(s.session_id));
          return [...list].sort((a,b) => {
            const wa = watchlist.has(a.session_id)?0:1, wb = watchlist.has(b.session_id)?0:1;
            if (wa !== wb) return wa - wb;
            return a.integrity_score - b.integrity_score;
          });
        };

        // ---- Card Management ----
        // Instead of innerHTML, we create/update individual card elements by session_id.
        // This way images are NEVER destroyed by DOM rebuilds.
        const cardElements = {}; // session_id -> DOM element

        const createCard = (s) => {
          const card = document.createElement("div");
          card.className = "student-card";
          card.dataset.sid = s.session_id;

          // Frame container with persistent <video> elements
          const frame = document.createElement("div");
          frame.className = "card-frame";
          frame.dataset.session = s.session_id;

          const videoMain = document.createElement("video");
          videoMain.className = "video-main";
          videoMain.autoplay = true;
          videoMain.muted = true;
          videoMain.playsInline = true;
          videoMain.style.display = "none";
          frame.appendChild(videoMain);

          const noFeed = document.createElement("span");
          noFeed.className = "no-feed";
          noFeed.textContent = s.status === "active" ? "Waiting for feed..." : "Exam Done";
          frame.appendChild(noFeed);

          const badge = document.createElement("span");
          badge.className = "card-badge";
          frame.appendChild(badge);

          const integrity = document.createElement("span");
          integrity.className = "card-integrity";
          frame.appendChild(integrity);

          card.appendChild(frame);

          // Watch button
          const watchBtn = document.createElement("button");
          watchBtn.className = "watch-btn";
          watchBtn.innerHTML = "&#9733;";
          watchBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (watchlist.has(s.session_id)) watchlist.delete(s.session_id); else watchlist.add(s.session_id);
            saveWatch();
            rebuildGrid();
          });
          card.appendChild(watchBtn);

          // Body
          const body = document.createElement("div");
          body.className = "card-body";
          body.innerHTML = `
            <div class="card-name"></div>
            <div class="card-email"></div>
            <div class="card-stats"></div>
            <div class="card-violations-mini"></div>
          `;
          card.appendChild(body);

          // Actions
          const actions = document.createElement("div");
          actions.className = "card-actions";
          const detailBtn = document.createElement("button");
          detailBtn.className = "button sm";
          detailBtn.textContent = "Detail";
          detailBtn.addEventListener("click", () => {
            selectedSessionId = s.session_id;
            renderLogs();
            document.querySelector(".logs-panel")?.scrollIntoView({ behavior: "smooth", block: "start" });
          });
          actions.appendChild(detailBtn);

          const endBtn = document.createElement("button");
          endBtn.className = "button sm danger";
          endBtn.textContent = "End Exam";
          endBtn.addEventListener("click", async () => {
            openModal(
              "Force end exam",
              `This will immediately finish the exam for ${s.student_name || "this student"} and trigger grading.`,
              null,
              async () => {
                try {
                  await Morpheus.forceFinishSession(s.session_id);
                  await pollData();
                } catch (err) {
                  console.error("[MONITOR] Force-end failed:", err);
                }
              },
            );
          });
          actions.appendChild(endBtn);

          const violationBtn = document.createElement("button");
          violationBtn.className = "button sm";
          violationBtn.textContent = "Add Violation";
          violationBtn.addEventListener("click", async () => {
            const select = document.createElement("select");
            Object.keys(VLABEL).forEach((key) => {
              const opt = document.createElement("option");
              opt.value = key;
              opt.textContent = VLABEL[key];
              select.appendChild(opt);
            });
            const wrap = document.createElement("div");
            const label = document.createElement("div");
            label.className = "helper";
            label.textContent = "Violation type";
            const helper = document.createElement("div");
            helper.className = "helper";
            helper.textContent = `Code: ${select.value}`;
            select.addEventListener("change", () => {
              helper.textContent = `Code: ${select.value}`;
            });
            wrap.appendChild(label);
            wrap.appendChild(select);
            wrap.appendChild(helper);
            openModal(
              "Add violation",
              `Log a violation for ${s.student_name || "this student"}. This will update integrity score.`,
              wrap,
              async () => {
                const key = select.value;
                try {
                  await Morpheus.sendViolation(s.session_id, key, 0.9, { source: "professor" });
                  await pollData();
                } catch (err) {
                  console.error("[MONITOR] Add violation failed:", err);
                }
              },
            );
          });
          actions.appendChild(violationBtn);

          const reviewBtn = document.createElement("button");
          reviewBtn.className = "button sm";
          reviewBtn.textContent = "Mark Review";
          reviewBtn.addEventListener("click", () => {
            if (reviewlist.has(s.session_id)) {
              reviewlist.delete(s.session_id);
            } else {
              reviewlist.add(s.session_id);
            }
            saveReview();
            rebuildGrid();
          });
          actions.appendChild(reviewBtn);
          card.appendChild(actions);

          cardElements[s.session_id] = card;
          return card;
        };

        const updateCard = (card, s) => {
          const isWatched = watchlist.has(s.session_id);
          const isFlagged = s.integrity_score < 50;
          const isReviewed = reviewlist.has(s.session_id);
          card.className = `student-card ${isReviewed ? "reviewed" : ""} ${isWatched ? "watched" : isFlagged ? "flagged" : ""}`;

          // Update badge
          const badge = card.querySelector(".card-badge");
          if (s.status === "active") {
            badge.className = "card-badge badge-active";
            badge.textContent = "Live";
          } else {
            badge.className = "card-badge badge-completed";
            badge.textContent = "Exam Done";
          }

          // Update integrity overlay
          const intEl = card.querySelector(".card-integrity");
          intEl.style.color = iColor(s.integrity_score);
          intEl.textContent = Math.round(s.integrity_score) + "%";

          // Update no-feed text
          const noFeed = card.querySelector(".no-feed");
          const mainVideo = card.querySelector(".video-main");
          if (mainVideo && mainVideo.srcObject && mainVideo.style.display !== "none") {
            if (noFeed) noFeed.style.display = "none";
          } else {
            if (noFeed) {
              noFeed.style.display = "";
              noFeed.textContent = s.status === "active" ? "Waiting for feed..." : "Exam Done";
            }
          }

          // Update watch button
          const watchBtn = card.querySelector(".watch-btn");
          watchBtn.className = `watch-btn ${isWatched ? "active" : ""}`;
          watchBtn.title = isWatched ? "Unwatch" : "Watch";

          // Update body
          card.querySelector(".card-name").textContent = s.student_name || "Unknown";
          card.querySelector(".card-email").textContent = s.student_email || "";
          card.querySelector(".card-stats").innerHTML = `
            <span><span class="dot" style="background:${iColor(s.integrity_score)}"></span>${Math.round(s.integrity_score)}% integrity</span>
            <span>${s.violation_count} violation${s.violation_count!==1?"s":""}</span>
          `;
          const chips = (s.recent_violations||[]).map(v =>
            `<span class="violation-chip">${VLABEL[v.type]||v.type}</span>`
          ).join("");
          const reviewChip = isReviewed
            ? '<span class="violation-chip" style="border-color:rgba(255,214,64,0.5);color:#ffd166;background:rgba(255,214,64,0.14)">Review</span>'
            : "";
          const chipMarkup = `${reviewChip}${chips || ""}`;
          card.querySelector(".card-violations-mini").innerHTML = chipMarkup || '<span style="font-size:10px;color:var(--muted)">No violations</span>';
        };

        const rebuildGrid = () => {
          renderStats();
          const visible = getVisible();

          if (!visible.length) {
            // Remove all cards from grid but keep them in cardElements for reuse
            grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);font-size:13px;">
              ${students.length ? "No students match current filter." : "No sessions found for this exam."}
            </div>`;
            return;
          }

          // Build the desired order of session IDs
          const desiredIds = visible.map(s => s.session_id);

          // Remove cards not in the visible set
          for (const child of Array.from(grid.children)) {
            if (child.dataset && child.dataset.sid && !desiredIds.includes(child.dataset.sid)) {
              grid.removeChild(child);
            } else if (!child.dataset || !child.dataset.sid) {
              grid.removeChild(child); // remove placeholder messages
            }
          }

          // Create/update cards and ensure correct order
          let prevNode = null;
          for (const s of visible) {
            let card = cardElements[s.session_id];
            if (!card) card = createCard(s);
            updateCard(card, s);

            // Ensure card is in grid and in correct position
            if (!card.parentNode || card.parentNode !== grid) {
              if (prevNode && prevNode.nextSibling) {
                grid.insertBefore(card, prevNode.nextSibling);
              } else if (!prevNode) {
                grid.insertBefore(card, grid.firstChild);
              } else {
                grid.appendChild(card);
              }
            }
            prevNode = card;
          }

          // Start/stop WebRTC per session
          visible.forEach((s) => {
            if (s.status === "active") {
              ensurePeer(s);
            } else {
              closePeer(s.session_id);
            }
          });

          const visibleIds = new Set(visible.map((s) => s.session_id));
          Object.keys(rtcPeers).forEach((sid) => {
            if (!visibleIds.has(sid)) {
              closePeer(sid);
            }
          });

          // Fix order if needed: ensure cards appear in correct sequence
          const currentOrder = Array.from(grid.querySelectorAll(".student-card")).map(c => c.dataset.sid);
          if (JSON.stringify(currentOrder) !== JSON.stringify(desiredIds)) {
            for (const s of visible) {
              const card = cardElements[s.session_id];
              if (card) grid.appendChild(card); // re-appending in order
            }
          }
        };

        // ---- WebRTC Viewer ----
        const ICE_SERVERS = [{ urls: "stun:stun.l.google.com:19302" }];
        const rtcPeers = {}; // session_id -> { pc, ws, mainVideo }

        const ensurePeer = async (s) => {
          const sid = s.session_id;
          if (rtcPeers[sid]) return;
          const card = cardElements[sid];
          if (!card) return;

          const wsBase = await window.Morpheus.getWebSocketBase();
          const token = window.Morpheus.getToken();
          const ws = new WebSocket(`${wsBase}/ws/webrtc/${sid}?token=${token}`);
          const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });

          const mainVideo = card.querySelector(".video-main");
          rtcPeers[sid] = { ws, pc, mainVideo };

          pc.ontrack = (event) => {
            const peer = rtcPeers[sid];
            if (!peer) return;
            const track = event.track;
            const stream = event.streams[0];
            if (track.kind === "video" && peer.mainVideo) {
              peer.mainVideo.srcObject = stream;
              peer.mainVideo.style.display = "block";
              peer.mainVideo.play().catch(() => {});
            }

            const noFeed = card.querySelector(".no-feed");
            if (noFeed) noFeed.style.display = "none";
          };

          pc.onicecandidate = (event) => {
            if (event.candidate) {
              ws.send(JSON.stringify({ type: "ice", candidate: event.candidate }));
            }
          };

          pc.onconnectionstatechange = () => {
            console.log(`[WEBRTC] ${sid} connection:`, pc.connectionState);
          };

          ws.onopen = () => {
            ws.send(JSON.stringify({ type: "register", role: "professor" }));
            ws.send(JSON.stringify({ type: "request_offer" }));
          };

          ws.onmessage = async (event) => {
            let message;
            try {
              message = JSON.parse(event.data);
            } catch {
              return;
            }
            if (message.type === "offer" && message.sdp) {
              await pc.setRemoteDescription(new RTCSessionDescription(message.sdp));
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              ws.send(JSON.stringify({ type: "answer", sdp: pc.localDescription }));
            }
            if (message.type === "ice" && message.candidate) {
              try {
                await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
              } catch (error) {
                console.warn("[WEBRTC] addIceCandidate failed:", error?.message || error);
              }
            }
            if (message.type === "peer_missing") {
              const noFeed = card.querySelector(".no-feed");
              if (noFeed) noFeed.textContent = "Waiting for student...";
            }
          };

          ws.onclose = () => {
            console.warn(`[WEBRTC] ${sid} signaling closed`);
          };
        };

        const closePeer = (sid) => {
          const peer = rtcPeers[sid];
          if (!peer) return;
          try { peer.ws.close(); } catch {}
          try { peer.pc.close(); } catch {}
          delete rtcPeers[sid];
        };

        // ---- Logs ----
        const renderLogs = () => {
          const sessionToName = new Map(students.map(s => [s.session_id, s.student_name || "Unknown"]));
          const filtered = selectedSessionId
            ? logs.filter(l => l.session_id === selectedSessionId)
            : logs;

          const title = selectedSessionId
            ? `Activity Log Â· ${sessionToName.get(selectedSessionId) || selectedSessionId.slice(0, 8)}`
            : "Live Activity Log";
          $("log-title").textContent = title;
          $("log-count").textContent = `${filtered.length} events`;

          if (!filtered.length) {
            logsEl.innerHTML = '<div class="log-empty">No activity logs yet.</div>';
            return;
          }
          const sorted = [...filtered].sort((a,b) => {
            return (b.created_at?new Date(b.created_at).getTime():0) - (a.created_at?new Date(a.created_at).getTime():0);
          });
          logsEl.innerHTML = sorted.slice(0,100).map(log => {
            const time = log.created_at ? new Date(log.created_at).toLocaleTimeString() : "--";
            const sid = log.session_id ? log.session_id.slice(0,8) : "--";
            const studentName = sessionToName.get(log.session_id) || "Unknown";
            const ev = log.event_type || "";
            const isV = !ev.startsWith("session_");
            const label = VLABEL[ev] || log.message || ev;
            const explain = log.explanation || VEXPLAIN[ev] || "";
            return `<div class="log-row">
              <span class="log-time">${time}</span>
              <span class="log-session">${sid}</span>
              <span class="log-student">${esc(studentName)}</span>
              <span class="log-event ${isV?'violation':'info'}">${esc(label)}</span>
              <span class="log-explain">${esc(explain)}</span>
            </div>`;
          }).join("");
        };

        // ---- Polling ----
        const pollData = async () => {
          if (paused) return;
          try {
            if (!examTitle) {
              try {
                const exams = await Morpheus.getProfessorExams();
                const m = (exams||[]).find(e => e.id === exam_id);
                if (m) examTitle = m.title;
              } catch(e) {}
            }
            const [liveData, logData] = await Promise.all([
              Morpheus.getLiveSessions(exam_id),
              Morpheus.getExamLogs(exam_id),
            ]);
            students = liveData.students || [];
            logs = logData || [];
            console.log(`[MONITOR] Data poll: ${students.length} students, ${logs.length} logs`);
            rebuildGrid();
            renderLogs();
          } catch (err) {
            console.error("[MONITOR] Poll error:", err.message);
          }
        };

        // ---- Filter/Search/Pause ----
        const setFilter = (f) => {
          filter = f;
          document.querySelectorAll(".toolbar .button").forEach(b => b.classList.remove("active-filter"));
          const btn = $(`filter-${f}`);
          if (btn) btn.classList.add("active-filter");
          rebuildGrid();
        };
        $("filter-all").addEventListener("click", () => setFilter("all"));
        $("filter-active").addEventListener("click", () => setFilter("active"));
        $("filter-flagged").addEventListener("click", () => setFilter("flagged"));
        $("filter-watched").addEventListener("click", () => setFilter("watched"));
        $("search").addEventListener("input", (e) => { search = e.target.value; rebuildGrid(); });
        $("btn-pause").addEventListener("click", () => {
          paused = !paused;
          $("btn-pause").innerHTML = paused ? '&#9654; Paused' : '<span class="live-dot"></span>Live';
          renderStats();
        });

        $("log-reset").addEventListener("click", () => {
          selectedSessionId = null;
          renderLogs();
        });

        actionCancel.addEventListener("click", closeModal);
        actionConfirm.addEventListener("click", async () => {
          if (!pendingAction) return closeModal();
          await pendingAction();
          closeModal();
        });

        // ---- Start ----
        console.log("[MONITOR] Starting for exam:", exam_id);
        setFilter("all");

        // First load: data then immediately frames
        pollData();

        // Data poll every 5s
        setInterval(pollData, 5000);

        // Frame poll every 1s (independent of data)
      })();
    </script>
  </body>
</html>
