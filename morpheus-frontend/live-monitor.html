<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Monitoring</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #000;
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.68);
        --border: rgba(255, 255, 255, 0.14);
        --border-strong: rgba(255, 255, 255, 0.22);
        --accent: #d7ff45;
        --shadow: 0 16px 60px rgba(0, 0, 0, 0.55);
        --radius: 20px;
        --radius-lg: 28px;
        --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
        --container: 1120px;

        --font-heading: "Anton", sans-serif;
        --font-body: "Proxima Nova", sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--font-body);
        background: linear-gradient(90deg, #222 0%, var(--bg) 60%);
        color: var(--text);
        min-height: 100vh;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      .title {
        font-family: var(--font-heading);
        font-weight: 400;
      }

      .page {
        padding: 28px 24px 64px;
      }

      .container {
        width: 100%;
        max-width: var(--container);
        margin: 0 auto;
        display: grid;
        gap: 24px;
      }

      .hero-head {
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
        padding-top: 6px;
      }

      .header-right {
        position: absolute;
        top: 0;
        right: -80px;
        display: flex;
        align-items: center;
      }

      .profile-trigger {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        padding: 2px;
        background: linear-gradient(160deg, rgba(0, 200, 150, 0.7), rgba(0, 150, 200, 0.9));
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .profile-trigger img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }

      .org-tab {
        width: calc(100% + 60px);
        margin-left: -30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      .org-brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .org-brand img {
        width: 40px;
        height: 40px;
        object-fit: contain;
      }

      .org-title {
        font-size: 16px;
        letter-spacing: 0.02em;
        text-transform: none;
        font-weight: 700;
      }

      .org-subtitle {
        font-size: 11px;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.5);
      }

      .org-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-right: 40px;
      }

      .org-status,
      .org-chip {
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 11px;
        letter-spacing: 0.2em;
      }

      .org-status {
        background: rgba(0, 214, 255, 0.14);
        color: #00d8ff;
      }

      .org-chip {
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.8);
      }

      .org-info {
        width: 100%;
        margin-top: 6px;
      }

      .org-info-row {
        display: flex;
        flex-wrap: wrap;
        gap: 18px;
        letter-spacing: 0.08em;
        font-size: 12px;
      }

      .org-info-name {
        font-weight: 700;
        text-transform: uppercase;
      }

      .org-info-status {
        color: #00d896;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }

      .title {
        font-size: 52px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        line-height: 1;
      }

      .subtitle {
        color: var(--muted);
        font-size: 14px;
        max-width: 520px;
        line-height: 1.7;
      }

      .button {
        border-radius: 999px;
        padding: 10px 16px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
        color: var(--text);
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        transition: transform 220ms var(--ease), border-color 220ms var(--ease), background 220ms var(--ease);
      }

      .button:hover {
        transform: translateY(-1px);
        border-color: var(--border-strong);
        background: rgba(255, 255, 255, 0.04);
      }

      .button.primary {
        background: var(--accent);
        color: rgba(0, 0, 0, 0.92);
        border-color: transparent;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
      }

      .card {
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.03);
        box-shadow: var(--shadow);
        padding: 16px;
        display: grid;
        gap: 12px;
      }

      .video-frame {
        border-radius: var(--radius);
        border: 1px solid var(--border-strong);
        background: linear-gradient(140deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
        height: 160px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        overflow: hidden;
      }

      .video-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .student-name {
        font-size: 16px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .violations {
        color: var(--muted);
        font-size: 13px;
      }

      .log-table {
        width: 100%;
        border-collapse: collapse;
      }

      .log-table th,
      .log-table td {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        text-align: left;
        font-size: 12px;
      }

      .log-table th {
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="container">
        <div class="hero-head">
          <div class="org-tab">
            <div class="org-brand">
              <img src="vit.png" alt="Org logo" />
              <div>
                <div class="org-title">Vishwakarma Institute of Technology</div>
                <div class="org-subtitle">Pune</div>
              </div>
            </div>
            <div class="org-actions">
              <span class="org-status">Verified</span>
              <span class="org-chip">FACULTY</span>
            </div>
          </div>
          <div class="org-info">
            <div class="org-info-row">
              <span class="org-info-name">Himanshu Deshmukh</span>
              <span class="org-info-status">Active</span>
              <span class="org-info-detail">Registration No: 12414955</span>
              <span class="org-info-detail">BTech - Computer Science and Engineering (AI &amp; ML)</span>
            </div>
          </div>
          <div class="header-right">
            <div class="profile-trigger">
              <img src="https://i.pravatar.cc/150?img=32" alt="Faculty profile" />
            </div>
          </div>
        </div>
        <header class="header">
          <div>
            <div class="title">Live Monitoring</div>
            <div class="subtitle">
              Real-time footage of students currently attempting the exam. Review violations beneath each feed.
            </div>
            <div class="subtitle" id="monitor-status"></div>
          </div>
          <div>
            <a class="button" href="faculty.html">Back to Dashboard</a>
          </div>
        </header>

        <section class="grid" aria-label="Live student monitoring"></section>

        <section class="card" aria-label="Exam logs">
          <div class="panel-head">
            <div>
              <div class="panel-title">Exam Logs</div>
              <div class="muted">Proctoring violations and system events for this exam.</div>
            </div>
          </div>
          <div style="overflow:auto;">
            <table class="log-table">
              <thead>
                <tr>
                  <th scope="col">Time</th>
                  <th scope="col">Session</th>
                  <th scope="col">Event</th>
                  <th scope="col">Explanation</th>
                </tr>
              </thead>
              <tbody id="logs-body"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
    <script src="api.js"></script>
    <script>
      const start = () => {
        if (!Morpheus.requireAuth("professor")) {
          return;
        }

        let exam_id =
          new URLSearchParams(window.location.search).get("exam_id") ||
          sessionStorage.getItem("morpheus_exam_id");

        const els = {
          container: document.querySelector("section.grid"),
          activeStatus: document.querySelector(".org-info-status"),
          logsBody: document.getElementById("logs-body"),
          monitorStatus: document.getElementById("monitor-status"),
        };

        const getIntegrity = (session) => {
          const value = Number(session?.integrity_score);
          return Number.isFinite(value) ? value : null;
        };

        const formatScore = (value) => {
          if (value === null || value === undefined) return "—";
          return value;
        };

        const integrityColor = (score) => {
          if (score === null) return "rgba(255,255,255,0.7)";
          if (score > 80) return "#00d896";
          if (score >= 50) return "#ffd166";
          return "#ff7a7a";
        };

        const renderSessionCards = (sessions) => {
          if (!els.container) return;
          const sorted = [...(sessions || [])].sort((a, b) => {
            const aIntegrity = getIntegrity(a) ?? 0;
            const bIntegrity = getIntegrity(b) ?? 0;
            const aFlagged = aIntegrity < 50;
            const bFlagged = bIntegrity < 50;
            if (aFlagged !== bFlagged) return aFlagged ? -1 : 1;
            return aIntegrity - bIntegrity;
          });

          els.container.innerHTML = "";
          if (!sorted.length) {
            const empty = document.createElement("div");
            empty.className = "card";
            empty.innerHTML = `<div class="student-name">No active sessions</div>`;
            els.container.appendChild(empty);
            return;
          }

          sorted.forEach((session) => {
            const integrity = getIntegrity(session);
            const card = document.createElement("div");
            card.className = "card";
            const sessionId = session.session_id || session.id || "";
            card.innerHTML = `
              <div class="video-frame" data-session="${sessionId}">Live Feed</div>
              <div class="student-name">${session.student_name || "Student"}</div>
              <div class="violations">Violations: ${session.violation_count ?? 0}</div>
              <div class="violations">Total Score: ${formatScore(session.total_score)}</div>
              <div class="violations" style="color:${integrityColor(integrity)};">Integrity: ${formatScore(integrity)}</div>
              <div class="violations">Status: ${session.status || "unknown"}</div>
              <div>
                <button class="button" type="button">View Detail</button>
              </div>
            `;
            const button = card.querySelector("button");
            button.addEventListener("click", () => {
              if (!sessionId) return;
              window.location.href = `result.html?session_id=${encodeURIComponent(sessionId)}`;
            });
            if (!sessionId) {
              button.disabled = true;
            }
            els.container.appendChild(card);
          });
        };

        const loadFrames = async (sessions) => {
          const frames = Array.from(document.querySelectorAll(".video-frame[data-session]"));
          await Promise.all(
            frames.map(async (frame) => {
              const sessionId = frame.getAttribute("data-session");
              if (!sessionId) return;
              try {
                const result = await Morpheus.getLiveFrame(sessionId);
                if (result?.frame_base64) {
                  frame.innerHTML = `<img src="${result.frame_base64}" alt="Live frame" />`;
                }
              } catch (error) {
                // ignore
              }
            })
          );
        };

        const renderLogs = (logs) => {
          if (!els.logsBody) return;
          if (!Array.isArray(logs) || logs.length === 0) {
            els.logsBody.innerHTML = `
              <tr>
                <td colspan="4" class="muted">No logs for this exam yet.</td>
              </tr>
            `;
            return;
          }
          els.logsBody.innerHTML = logs
            .map((log) => {
              const time = log.created_at ? new Date(log.created_at).toLocaleString() : "—";
              const session = log.session_id ? log.session_id.slice(0, 8) : "—";
              const event = log.message || log.event_type || "—";
              const explanation = log.explanation || "—";
              return `
                <tr>
                  <td>${time}</td>
                  <td>${session}</td>
                  <td>${event}</td>
                  <td>${explanation}</td>
                </tr>
              `;
            })
            .join("");
        };

        const resolveExam = async () => {
          if (exam_id) return exam_id;
          try {
            const exams = await Morpheus.getProfessorExams();
            if (exams?.length) {
              const sorted = [...exams].sort(
                (a, b) => new Date(b.start_time).getTime() - new Date(a.start_time).getTime()
              );
              exam_id = sorted[0].id;
              sessionStorage.setItem("morpheus_exam_id", exam_id);
            }
          } catch (error) {
            // ignore
          }
          return exam_id;
        };

        const loadSessions = async () => {
          await resolveExam();
          if (!exam_id) {
            renderSessionCards([]);
            renderLogs([]);
            if (els.monitorStatus) {
              els.monitorStatus.textContent = "No exam selected.";
            }
            return;
          }
          let sessions = [];
          try {
            sessions = await Morpheus.getExamResults(exam_id);
          } catch (error) {
            sessions = [];
            if (els.monitorStatus) {
              els.monitorStatus.textContent = `Exam ${exam_id}: Failed to load sessions`;
            }
          }
          renderSessionCards(sessions);
          if (els.activeStatus) {
            const activeCount = sessions.filter((session) => session.status === "active").length;
            els.activeStatus.textContent = `Active (${activeCount})`;
          }

          if (els.monitorStatus) {
            els.monitorStatus.textContent = `Exam ${exam_id}: ${sessions.length} session(s)`;
          }

          loadFrames(sessions);

          try {
            const logs = await Morpheus.getExamLogs(exam_id);
            renderLogs(logs);
            if (els.monitorStatus) {
              els.monitorStatus.textContent = `Exam ${exam_id}: ${sessions.length} session(s), ${logs.length} log(s)`;
            }
          } catch (error) {
            renderLogs([]);
          }
        };

        loadSessions();
        setInterval(loadSessions, 10000);
      };

      start();
    </script>
  </body>
</html>
